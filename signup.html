<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>สมัครสมาชิก - VG SHOP</title>
        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="styles.css">
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
        <script type="text/javascript">
            (function(){
                emailjs.init("ec8yJSGmW3AwGLnR4"); // ใส่ Public Key ของคุณตรงนี้
            })();
        </script>
    </head>
    <body>

        <header class="site-header">
            <div class="container">
                <div class="header-layout">
                    <div class="logo-area">
                        <a href="homepage.html" class="brand-logo">VG SHOP</a>
                    </div>
                    <nav class="center-nav">
                        <ul>
                            <li><a href="homepage.html">หน้าหลัก</a></li>
                            <li><a href="#">ร้านค้า</a></li>
                            <li><a href="#">การ์ด</a></li>
                            <li><a href="#">เด็ค</a></li>
                        </ul>
                    </nav>
                    <div class="right-actions"></div>
                </div>
            </div>
        </header>

        <section class="login-section">
            <div class="login-card" style="max-width: 500px;">
                <h2>สมัครสมาชิก</h2>
                <p class="sub-text">สร้างบัญชีเพื่อเริ่มต้นใช้งาน</p>
                
                <form id="signupForm" onsubmit="handleSignup(event)">
                    
                    <div class="form-group">
                        <label for="username">ชื่อผู้ใช้ (Username) <span style="color:red">*</span></label>
                        <input type="text" id="username" class="form-input" placeholder="ตั้งชื่อผู้ใช้ของคุณ" required>
                    </div>

                    <div class="form-group">
                        <label for="email">อีเมล <span style="color:red">*</span></label>
                        <div style="display: flex; gap: 10px;">
                            <input type="email" id="email" class="form-input" placeholder="example@email.com" required>
                            <button type="button" id="btnSendCode" onclick="sendOTP()" class="btn-outline" style="white-space: nowrap; padding: 0 20px; font-size: 14px;">ส่งรหัส</button>
                        </div>
                        <small id="emailHelp" style="color: #666; font-size: 12px; display: none;">รหัสถูกส่งไปยังอีเมลแล้ว</small>
                    </div>

                    <div class="form-group">
                        <label for="verifyCode">รหัสยืนยัน (จากอีเมล) <span style="color:red">*</span></label>
                        <input type="text" id="verifyCode" class="form-input" placeholder="กรอกรหัส 6 หลัก" maxlength="6" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">รหัสผ่าน <span style="color:red">*</span></label>
                        <input type="password" id="password" class="form-input" placeholder="กำหนดรหัสผ่าน" required>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">ยืนยันรหัสผ่าน <span style="color:red">*</span></label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="กรอกรหัสผ่านอีกครั้ง" required>
                    </div>

                    <button type="submit" class="btn-login" style="margin-top: 20px;">ยืนยันการสมัคร</button>
                </form>

                <div class="divider">
                    <span>มีบัญชีอยู่แล้ว?</span>
                </div>

                <a href="sign.html" style="text-decoration: none;">
                    <button type="button" class="btn-register">เข้าสู่ระบบ</button>
                </a>
            </div>
        </section>

        <footer class="site-footer">
            <div class="container">
                <div class="footer-layout">
                    <div class="footer-left">
                        <h2>VG SHOP</h2>
                        <p>ศูนย์รวมการ์ดเกมที่ครบวงจรที่สุด</p>
                    </div>
                    <div class="footer-right">
                        <p>&copy; 2024 VG Shop. All rights reserved.</p>
                    </div>
                </div>
            </div>
        </footer>

        <div id="successModal" class="modal-overlay">
            <div class="modal-box">
                <div class="success-checkmark">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                        <div class="icon-circle"></div>
                        <div class="icon-fix"></div>
                    </div>
                </div>
                <h3>สมัครสมาชิกเรียบร้อย!</h3>
                <p>ระบบจะพาคุณไปหน้าเข้าสู่ระบบใน <span id="countdownTimer" style="font-weight:bold; color:#000;">3</span> วินาที...</p>
                <button class="btn-login" onclick="closeModal()" style="margin-top: 20px; width: auto; padding-left: 30px; padding-right: 30px;">ไปหน้าเข้าสู่ระบบทันที</button>
            </div>
        </div>

        <script type="module">
            // 1. นำเข้า Firebase SDK
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

            // 2. ใส่ค่า Config จริงของคุณที่คัดลอกมา (ผมใส่ตามรูปที่คุณเคยส่งมาให้)
            const firebaseConfig = {
                apiKey: "AIzaSyAV3snK_1l53ZX1ITml_crwAJSrJP_3BIU",
                authDomain: "vg-shop-c7056.firebaseapp.com",
                projectId: "vg-shop-c7056",
                storageBucket: "vg-shop-c7056.firebasestorage.app",
                messagingSenderId: "630247091832",
                appId: "1:630247091832:web:d885fe3dfc610501fc478d",
                measurementId: "G-CDDZVHLC2G"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            let generatedOTP = "";

            // 3. แก้ไขให้ปุ่ม "ส่งรหัส" มองเห็นฟังก์ชันนี้ (ใช้ window.)
            window.sendOTP = function() {
                const email = document.getElementById('email').value;
                if (!email) {
                    alert("กรุณากรอกอีเมลก่อน!");
                    return;
                }

                generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

                // ส่งผ่าน EmailJS
                emailjs.send("service_x8fexol", "template_a0352y9", {
                    user_email: email,
                    otp_code: generatedOTP,
                }).then(() => {
                    alert("ส่งรหัส OTP เรียบร้อย! ตรวจสอบที่อีเมลของคุณ");
                }).catch((err) => {
                    alert("เกิดข้อผิดพลาดในการส่งอีเมล");
                    console.error(err);
                });
            }

            // 4. ฟังก์ชันสมัครสมาชิก
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const userOTP = document.getElementById('otp').value;

                if (password !== confirmPassword) {
                    alert("รหัสผ่านไม่ตรงกัน!");
                    return;
                }

                if (userOTP !== generatedOTP) {
                    alert("รหัส OTP ไม่ถูกต้อง!");
                    return;
                }

                try {
                    // บันทึกข้อมูลลง Firebase
                    await createUserWithEmailAndPassword(auth, email, password);
                    
                    // แสดง Modal สำเร็จ
                    document.getElementById('successModal').style.display = 'flex';
                    
                    // เริ่มนับถอยหลัง
                    let timeLeft = 5;
                    const timerElement = document.getElementById('timer');
                    const interval = setInterval(() => {
                        timeLeft--;
                        timerElement.innerText = timeLeft;
                        if (timeLeft <= 0) {
                            clearInterval(interval);
                            window.location.href = 'sign.html';
                        }
                    }, 1000);

                } catch (error) {
                    alert("ผิดพลาด: " + error.message);
                }
            });
        </script>
    </body>
</html>
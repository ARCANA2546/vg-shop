<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ตั้งค่าบัญชี - VG SHOP</title>
        <link rel="stylesheet" href="styles.css">
        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </head>
    <body>

        <header class="site-header">
            <div class="container header-layout">
                <a href="homepage.html" class="brand-logo">VG SHOP</a>
                <a href="account-info.html" style="color: #666;"><i class="fa-solid fa-arrow-left"></i> กลับไปหน้าข้อมูลบัญชี</a>
            </div>
        </header>

        <main class="login-section" style="padding: 40px 0;">
            <div class="login-card" style="max-width: 500px; margin: 0 auto;">
                <h2 style="text-align: center;"><i class="fa-solid fa-user-gear"></i> ตั้งค่าบัญชี</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px;">จัดการข้อมูลส่วนตัวของคุณ</p>
                
                <form id="updateProfileForm">
                    <div class="form-group" style="text-align: center;">
                        <img id="current-avatar" src="" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; display: none; margin: 0 auto 10px;">
                        <label>URL รูปโปรไฟล์ใหม่</label>
                        <input type="text" id="new-photo-url" class="form-input" placeholder="วางลิงก์รูปภาพ (เช่นจาก Google Drive หรือเว็บฝากรูป)">
                    </div>

                    <div class="form-group">
                        <label>ชื่อผู้ใช้งาน (Username)</label>
                        <input type="text" id="new-name" class="form-input" placeholder="ใส่ชื่อใหม่ที่ต้องการ">
                    </div>

                    <div style="background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px;">
                        <label style="font-weight: 600; font-size: 0.9rem; color: #555;">เปลี่ยนรหัสผ่าน</label>
                        <div class="form-group" style="margin-top: 10px;">
                            <input type="password" id="new-password" class="form-input" placeholder="รหัสผ่านใหม่">
                        </div>
                        <div class="form-group">
                            <input type="password" id="confirm-new-password" class="form-input" placeholder="ยืนยันรหัสผ่านใหม่">
                        </div>
                    </div>

                    <button type="submit" class="btn-login" style="background: #000;">บันทึกข้อมูลทั้งหมด</button>
                </form>

                <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

                <div id="verification-section" style="text-align: center;">
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">สถานะการยืนยันอีเมล: <span id="verify-status">กำลังโหลด...</span></p>
                    <button id="sendVerifyEmail" class="btn-outline" style="width: 100%; display: none;">ส่งอีเมลยืนยันตัวตนอีกครั้ง</button>
                </div>
            </div>
        </main>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, onAuthStateChanged, updateProfile, updatePassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyAV3snK_1l53ZX1ITml_crwAJSrJP_3BIU",
                authDomain: "vg-shop-c7056.firebaseapp.com",
                projectId: "vg-shop-c7056",
                storageBucket: "vg-shop-c7056.firebasestorage.app",
                messagingSenderId: "630247091832",
                appId: "1:630247091832:web:d885fe3dfc610501fc478d",
                measurementId: "G-CDDZVHLC2G"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // โหลดข้อมูลปัจจุบันมาโชว์ใน Placeholder
                    document.getElementById('new-name').value = user.displayName || "";
                    document.getElementById('new-photo-url').value = user.photoURL || "";
                    
                    if(user.photoURL) {
                        const avatarImg = document.getElementById('current-avatar');
                        avatarImg.src = user.photoURL;
                        avatarImg.style.display = 'block';
                    }

                    // เช็คสถานะยืนยันตัวตน
                    const verifyStatus = document.getElementById('verify-status');
                    const verifyBtn = document.getElementById('sendVerifyEmail');
                    
                    if (user.emailVerified) {
                        verifyStatus.innerHTML = '<span style="color: green;">ยืนยันแล้ว</span>';
                        verifyBtn.style.display = 'none';
                    } else {
                        verifyStatus.innerHTML = '<span style="color: red;">ยังไม่ได้ยืนยัน</span>';
                        verifyBtn.style.display = 'block';
                    }
                } else {
                    window.location.href = 'sign.html';
                }
            });

            // ฟังก์ชันบันทึกข้อมูล
            document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const newName = document.getElementById('new-name').value;
                const newPhoto = document.getElementById('new-photo-url').value;
                const newPass = document.getElementById('new-password').value;
                const confirmPass = document.getElementById('confirm-new-password').value;

                try {
                    // 1. อัปเดตโปรไฟล์ (ชื่อและรูป)
                    await updateProfile(user, {
                        displayName: newName,
                        photoURL: newPhoto
                    });

                    // 2. อัปเดตรหัสผ่าน (ถ้ามีการกรอก)
                    if (newPass) {
                        if (newPass !== confirmPass) {
                            alert("รหัสผ่านใหม่ไม่ตรงกัน!");
                            return;
                        }
                        await updatePassword(user, newPass);
                    }

                    alert("อัปเดตข้อมูลสำเร็จ!");
                    window.location.href = 'account-info.html';
                } catch (error) {
                    alert("เกิดข้อผิดพลาด: " + error.message);
                }
            });

            // ฟังก์ชันส่งอีเมลยืนยันตัวตน
            document.getElementById('sendVerifyEmail').addEventListener('click', async () => {
                try {
                    await sendEmailVerification(auth.currentUser);
                    alert("ส่งอีเมลยืนยันตัวตนไปที่ " + auth.currentUser.email + " แล้ว กรุณาตรวจสอบในกล่องจดหมายของคุณ");
                } catch (error) {
                    alert("ไม่สามารถส่งอีเมลได้: " + error.message);
                }
            });
        </script>
    </body>
</html>
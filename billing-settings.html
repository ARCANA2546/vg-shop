<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>เติมเงินเข้าระบบ - VG SHOP</title>
        <link rel="stylesheet" href="styles.css">
        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </head>
    <body>

        <header class="site-header">
            <div class="container header-layout">
                <a href="homepage.html" class="brand-logo">VG SHOP</a>
                <a href="homepage.html" style="color: #666;"><i class="fa-solid fa-house"></i> กลับหน้าหลัก</a>
            </div>
        </header>

        <main class="login-section" style="padding: 40px 0;">
            <div class="login-card" style="max-width: 550px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 5px;"><i class="fa-solid fa-coins" style="color: #f1c40f;"></i> เติมเงินเพื่อรับพอยท์</h3>
                    <p style="color: #666; font-size: 0.9rem;">เติมเงินผ่านพร้อมเพย์เพื่อใช้ซื้อสินค้าในร้าน</p>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4 style="font-size: 1rem; margin-bottom: 10px;">ประวัติการเติมเงินล่าสุด</h4>
                    <div id="transaction-list">
                        <p style="text-align: center; color: #999; font-size: 0.85rem;">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>

                <hr style="margin-bottom: 25px; border: 0; border-top: 1px solid #eee;">

                <form id="topupForm">
                    <div class="form-group">
                        <label>จำนวนเงินที่ต้องการเติม (บาท)</label>
                        <input type="number" id="topup-amount" class="form-input" placeholder="ระบุจำนวนเงิน เช่น 100" min="1" required oninput="calculatePoints()">
                        <p style="font-size: 0.85rem; color: #27ae60; margin-top: 5px;">
                            คุณจะได้รับ: <span id="received-points">0</span> พอยท์
                        </p>
                    </div>

                    <div id="promptpay-qr-area" style="text-align: center; background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #0056b3;">
                        <p style="font-size: 0.85rem; color: #0056b3; margin-bottom: 10px; font-weight: bold;">สแกนผ่านแอปธนาคารทุกแห่ง</p>
                        <img id="qr-image" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=0624451412" alt="PromptPay QR Code" style="width: 200px; height: 200px; margin-bottom: 10px;">
                        <p style="font-weight: 600; font-size: 1.1rem; color: #333;">เบอร์พร้อมเพย์: 062-445-1412</p>
                        <small style="color: #666;">(ยอดเงินที่ต้องโอนจะระบุตามที่คุณกรอกข้างต้น)</small>
                    </div>

                    <div class="form-group">
                        <label>แนบหลักฐาน (เลขอ้างอิงจากสลิป)</label>
                        <input type="text" id="slip-ref" class="form-input" placeholder="ระบุเลขอ้างอิง 10-18 หลัก" required>
                    </div>

                    <button type="submit" class="btn-login" style="background: #000;">
                        <i class="fa-solid fa-check-circle"></i> ยืนยันการเติมเงิน
                    </button>
                </form>
            </div>
        </main>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyAV3snK_1l53ZX1ITml_crwAJSrJP_3BIU",
                authDomain: "vg-shop-c7056.firebaseapp.com",
                projectId: "vg-shop-c7056",
                storageBucket: "vg-shop-c7056.firebasestorage.app",
                messagingSenderId: "630247091832",
                appId: "1:630247091832:web:d885fe3dfc610501fc478d",
                measurementId: "G-CDDZVHLC2G"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // คำนวณพอยท์สดๆ
            window.calculatePoints = function() {
                const amount = document.getElementById('topup-amount').value;
                const points = amount ? parseInt(amount) : 0; // เรท 1:1
                document.getElementById('received-points').innerText = points.toLocaleString();
                
                // ปรับ QR Code ให้แสดงจำนวนเงิน (ถ้าใช้ API ที่รองรับการฝังยอดเงิน)
                // ตัวอย่างนี้ใช้ qrserver แบบพื้นฐาน
            }

            onAuthStateChanged(auth, (user) => {
                if (user) listenToTransactions(user.uid);
                else window.location.href = 'sign.html';
            });

            // ดึงประวัติการเติมเงิน (Real-time)
            function listenToTransactions(uid) {
                const q = query(
                    collection(db, "transactions"), 
                    where("userId", "==", uid),
                    orderBy("createdAt", "desc"),
                    limit(5)
                );

                onSnapshot(q, (snapshot) => {
                    const list = document.getElementById('transaction-list');
                    list.innerHTML = "";
                    
                    if (snapshot.empty) {
                        list.innerHTML = '<p style="text-align: center; color: #999; font-size: 0.85rem;">ยังไม่มีประวัติการเติมเงิน</p>';
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.createdAt?.toDate().toLocaleDateString('th-TH');
                        
                        list.innerHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                                <div>
                                    <i class="fa-solid fa-arrow-up-right-from-square" style="color: #27ae60; margin-right: 8px;"></i>
                                    <span>เติมเงิน ${data.amount} บาท</span>
                                    <div style="font-size: 0.75rem; color: #999;">${date} | Ref: ${data.slipRef}</div>
                                </div>
                                <span style="font-weight: bold; color: #27ae60;">+${data.points} P</span>
                            </div>`;
                    });
                });
            }

            // ส่งข้อมูลเติมเงิน
            document.getElementById('topupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseInt(document.getElementById('topup-amount').value);
                const slipRef = document.getElementById('slip-ref').value;
                const user = auth.currentUser;

                try {
                    // บันทึกรายการเติมเงินเข้าคอลเลกชัน transactions
                    await addDoc(collection(db, "transactions"), {
                        userId: user.uid,
                        amount: amount,
                        points: amount, // 1 บาท = 1 พอยท์
                        slipRef: slipRef,
                        status: "pending", // ตั้งสถานะว่ารอตรวจสอบ (หรือสำเร็จทันทีตามต้องการ)
                        createdAt: new Date()
                    });

                    alert("ส่งข้อมูลเติมเงินเรียบร้อยแล้ว! พอยท์จะเข้าบัญชีของคุณเร็วๆ นี้");
                    document.getElementById('topupForm').reset();
                    document.getElementById('received-points').innerText = "0";
                } catch (error) {
                    alert("เกิดข้อผิดพลาด: " + error.message);
                }
            });
        </script>
    </body>
</html>